#! /bin/sh


case "$1" in

	-h|--help)

		echo "${0##*/}: Copy binaries and their dependencies to a directory."
		echo "Usage: ${0##*/} [-h|--help] <directory> <binaries>"
		exit

	;;

	-d|--debug)

		set -x
		shift

	;;

esac

_e () { echo -e "${0##*/}: \e[31mError:\e[0m $@" >&2; exit 1; }




#		Check the command line.

test $# -lt 2 &&
	_e "Too few arguments."

dst="$1"
shift




#		Check if arguments are files.

for f in "$@"; do
	test -f "$f" ||
		_e "'$f' is not a file."
done




#		Copy the binaries.

for f in "$@"; do
	mkdir -p "$dst/${f%/*}"
	cp -u "$f" "$dst/$f"

	#	Copy the libraries.

	ldd "$f"         |
	cut -d " " -f 3  |
	grep -v -E       \
		-e 'dynamic' \
		-e '(^$|:$)' |
	sort -u          |
	while read l; do
		test -f "$l" ||
			_e "Missing dependency of '$f': '$l'."

		mkdir -p "$dst/${l%/*}"
		cp -u "$l" "$dst/$l"
	done
done
