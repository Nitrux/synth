#! /bin/sh


err () { printf "${0##*/}: \e[31mError:\e[0m %s\n" "$*" >&2; exit 1; }

case "$1" in
    ( -h | --help )
        printf "%s\n" \
            "${0##*/}: Copy binaries and their dependencies to a directory." \
            "the list of binaries will be read from stdin." \
            "" \
            "usage:" \
            "  ${0##*/} [-h|--help]  show this help." \
            "  ${0##*/} <dir>"
        exit;;

    ( -d | --debug )
        set -x
        shift;;
esac


#   Check the command line.

test $# -lt 2 &&
    err "Too few arguments."

dst="$1"
shift


#   Check if the arguments are files.

for f in "$@"; do
    test -f "$f" ||
        err "'$f' is not a file."
done


for f in "$@"; do
    #   Copy the binaries.

    mkdir -p "$dst/${f%/*}"
    cp -u "$f" "$dst/$f"

    #   Copy the libraries.

    ldd "$f" \
    | cut -d " " -f 3  \
    | grep -vE -e 'dynamic'	-e '(^$|:$)' \
    | sort -u \
    | while read l; do
        test -f "$l" ||
            err "missing dependency of '$f': '$l'."

        mkdir -p "$dst/${l%/*}"
        cp -u "$l" "$dst/$l"
    done
done
