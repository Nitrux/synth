#! /bin/sh

set -e

case $1 in

	-h|--help)

		echo "${0##*/}: Copy binaries and their dependencies to a directory."
		echo "Usage: ${0##*/} [-h|--help] <directory> <binaries>"
		exit

	;;

esac

_e () { echo -e "${0##*/}: \e[31mError:\e[0m $@" >&2; exit 1; }


#   Check the command line.

[ $# -lt 2 ] &&
	_e "Too few arguments."


#   Copy the binaries.

d=$1
shift

for f in $@; do
	[ -f "$f" ] ||
		_e "'$f' is not a file."

	mkdir -p $d/${f%/*}
	cp -u $f $d/$f
done


#   Copy the libraries. (Oh, if we had static binaries everywhere!)

ldd $@ |
awk '
	$1 ~/^\// { print $1 }
	$3 ~/^\// { print $3 }
' |
sed '/:$/d' |
sort -u |
while read l; do
	mkdir -p $d/${l%/*}
	cp -u $l $d/$l
done
